#BEFORE STARTING OUR CLASS, PLEASE RUN THIS SNIPPET TO INSTALL/LOAD OUR LIBRARIES NEEDED FOR THIS LESSON

packages_needed <- c('car', 'reshape2', 'HH', 'lme4')
for (package_name in packages_needed) {      
  if (!(package_name %in% rownames(installed.packages()))){
    install.packages(package_name)
  }
}
for (i in 1:length(packages_needed))
{
  library(packages_needed[[i]],character.only=TRUE)
}

#load our dataset
hemo <- read.csv('Hemo_exp.csv')

#boxplot of the hemo data
boxplot(hemo , las = 1, xlab = 'Groups', ylab = "Hemoglobin Level (g/dL)", col = 'blue')

#we want to organize our data into independent and dependent variable
#lets get a 'molten' dataset 
m.hemo <- melt(hemo)
#change the names of the cols
colnames(m.hemo)<- c('Group', 'Bloodlv')

#run the ANOVA for our hemoglobin example
#One Way Anova (Completely Randomized Design)
group <- m.hemo$Group
aov.ex1 <- aov(m.hemo$Bloodlv~group,data = m.hemo)

#checking the result of the anova
summary(aov.ex1)

#tukey post hoc
post_hoc.ex1<- TukeyHSD(aov.ex1, 'group', conf.level =0.95)
post_hoc.ex1

#lets see the confidence intervals generated by the anova
confint(aov.ex1, level = 0.90)
#some interesting plots for anova
plot(aov.ex1)
#pairwise confidence

#set the contrasts
options(contrasts = rep ("contr.treatment", 2))

aov.ex1.pairwise <- mmc(aov.ex1, linfct = mcp(group = "Tukey"))
aov.ex1.pairwise
mmcplot(aov.ex1.pairwise)

######################################################################################################
######################################################################################################
#UNBALANCED DESIGN EXPERIMENT

#load the unbalanced data
assim_hemo<- read.csv('Assimetric_Hemo_exp.csv')

#melt the unbalanced data
m.assim_hemo<- melt(assim_hemo)
#change the names of the cols
colnames(m.assim_hemo)<- c('Group', 'Bloodlv')
aov.ex2 <- aov(m.assim_hemo$Bloodlv~m.assim_hemo$Group,data = m.assim_hemo)

#checking the result of the anova
summary(aov.ex2)

#tukey post hoc
post_hoc.ex2<- TukeyHSD(aov.ex2, 'm.assim_hemo$Group', conf.level =0.95)
post_hoc.ex2

#lets see the confidence intervals generated by the anova
confint(aov.ex2, level = 0.90)
#some interesting plots for anova
plot(aov.ex2)
#set the constrasts
options(contrasts = rep ("contr.treatment", 2))
#pairwise confidence
aov.ex2.pairwise <- mmc(aov.ex2)
aov.ex2.pairwise
mmcplot(aov.ex2.pairwise)


#load the block data
block_hemo <- read.csv('Block_Hemo_exp.csv')

#melt the data
m.block_hemo<- melt(block_hemo)
#change the names of the cols
colnames(m.block_hemo)<- c('Group', 'Bloodlv')

######################################################################################################
######################################################################################################

#Run the ANOVA with the random design
#use the library lm4 to fit a linear model
fit.rand<- lmer(m.block_hemo$Bloodlv ~ (1|m.block_hemo$Group), data = m.block_hemo)
#the (1| ) notation means the granularity of the random effect alpha

#run the summary
summary(fit.rand)

#get the confidence intervals
confint(fit.rand, oldNames = FALSE)

#lets see what happens when we use the aov
options(contrasts = c("contr.sum", "contr.poly"))
aov.rand <- aov(m.block_hemo$Bloodlv~m.block_hemo$Group,data = m.block_hemo)
#confidence intervals of the anova
confint(aov.rand)

post_hoc.rand <- TukeyHSD(aov.rand, 'm.block_hemo$Group', conf.level =0.95)
post_hoc.rand

## "estimated" (better: conditional means of) random effects
ranef(fit.rand)

#set the constrasts
options(contrasts = rep ("contr.treatment", 2))
#pairwise confidence
aov.rand.pairwise <- mmc(aov.rand)
aov.rand.pairwise
mmcplot(aov.rand.pairwise)

######################################################################################################
######################################################################################################

#Run the ANOVA with the block design

#create a vector with the blocking factors for each element in the response
blk <- rep(seq(1:50),9)
#concatenate with the melted dataset
m.block_hemo <- data.frame(m.block_hemo, blk)

#Random block one Way Anova (Completely Randomized Design)
aov.block <- aov(m.block_hemo$Bloodlv~m.block_hemo$Group + m.block_hemo$blk,data = m.block_hemo)

#checking the result of the anova
summary(aov.block)

#lets see the confidence intervals generated by the anova
confint(aov.block, level = 0.90)
#some interesting plots for anova
plot(aov.block)

#tukey post hoc
post_hoc.block <- TukeyHSD(aov.block, 'm.block_hemo$Group', conf.level =0.95)
post_hoc.block


#set the constrasts
options(contrasts = rep ("contr.treatment", 2))


#pairwise confidence
aov.block.pairwise <- mmc(aov.block)
aov.block.pairwise
mmcplot(aov.block.pairwise, ylab="Comparison of Levels")


######################################################################################################
######################################################################################################
######################################################################################################
######################################################################################################


#Preparing the dataset for the two-way anova
Gender <- rep(c(rep('m',10),rep('f',10)),4)
m.hemo_2 <- data.frame(m.hemo,Gender)

group = m.hemo_2$Group
#Two way anova without error
aov.two<- aov(m.hemo_2$Bloodlv~group * m.hemo_2$Gender,data =m.hemo_2)

#checking the result of the anova
summary(aov.two)

#lets see the confidence intervals generated by the anova
confint(aov.two, level = 0.90)
#some interesting plots for anova
plot(aov.two)

#tukey post hoc
post_hoc.two <- TukeyHSD(aov.two, 'm.hemo_2$Group', conf.level =0.95)
post_hoc.two


#set the constrasts
options(contrasts = rep ("contr.treatment", 2))


#pairwise confidence

aov.two.pairwise <- mmc(aov.two, linfct = mcp(group = "Tukey"))
aov.two.pairwise
mmcplot(aov.two.pairwise, ylab="Comparison of Levels")


